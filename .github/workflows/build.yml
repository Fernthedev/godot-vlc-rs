name: Build GDExtension

on:
    push:
    pull_request:
        branches: [master]
    workflow_dispatch:

jobs:
    build:
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                include:
                    - os: ubuntu-latest
                      platform: linux
                    - os: windows-latest
                      platform: windows
                    - os: macos-latest
                      platform: macos

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  submodules: recursive

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Build GDExtension
              run: |
                  ./scripts/zip.ps1 ${{ matrix.platform }}
              shell: bash

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.platform }}-build
                  path: ./build/*.zip

    combine:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Download all build artifacts
              uses: actions/download-artifact@v4
              with:
                  path: all-builds

            - name: Combine all builds into one zip
              run: |
                  mkdir -p combined
                  find all-builds -name "*.zip" -exec unzip -o -d combined {} \;
                  cd combined
                  zip -r ../godot-vlc-all-platforms.zip .

            - name: Upload combined artifact
              uses: actions/upload-artifact@v4
              with:
                  name: godot-vlc-all-platforms
                  path: godot-vlc-all-platforms.zip

            - name: Create release if tagged
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  files: godot-vlc-all-platforms.zip
